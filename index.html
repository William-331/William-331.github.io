<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Xmas Cinema - Architectural Majesty</title>
    <style>
        :root { --gold: #d4af37; --bg: #050a05; --panel: rgba(10, 20, 10, 0.98); --red: #ff4d4d; }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; color: var(--gold); }
        
        #start-overlay {
            position: fixed; inset: 0; background: radial-gradient(circle, #1a301a 0%, #050a05 100%);
            z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #sidebar {
            position: fixed; left: 0; top: 0; width: 60vw; height: 100vh; max-width: 240px;
            background: var(--panel); border-right: 1px solid var(--gold);
            z-index: 100; padding: 25px; box-sizing: border-box;
            display: flex; flex-direction: column; backdrop-filter: blur(20px);
            transform: translateX(-220px); transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #sidebar:hover { transform: translateX(0); }
        #sidebar h3 { margin: 0 0 20px; border-bottom: 1px solid var(--gold); padding-bottom: 10px; font-weight: 300; letter-spacing: 2px; }
        
        .upload-section { background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid rgba(212, 175, 55, 0.1); }
        .section-title { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; }
        
        .resource-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .resource-item {
            padding: 12px; border: 1px solid rgba(212, 175, 55, 0.15); margin-bottom: 10px;
            border-radius: 6px; font-size: 13px; display: flex; flex-direction: column;
            background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .resource-item:hover { border-color: var(--gold); background: rgba(212, 175, 55, 0.1); }
        /* æ–¹æ¡ˆ A: æ–°å¢æ»‘åŠ¨æ¡æ ·å¼ */
        .vol-controls { display: flex; align-items: center; width: 100%; margin-top: 10px; opacity: 0.8; }
        .vol-slider { flex-grow: 1; height: 4px; accent-color: var(--gold); cursor: pointer; margin: 0 10px; }
        .vol-label { font-size: 10px; width: 30px; }
        .delete-btn { color: var(--red); cursor: pointer; padding: 5px 10px; font-size: 18px; line-height: 1; }
        .delete-btn:hover { transform: scale(1.3); text-shadow: 0 0 10px var(--red); }
        .btn-ui { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 8px 16px; cursor: pointer; font-size: 12px; border-radius: 4px; transition: 0.3s; }
        .btn-ui:hover { background: var(--gold); color: #000; }
        #now-playing { position: fixed; top: 20px; right: 20px; text-align: right; pointer-events: none; z-index: 10; }
        #canvas-container { width: 100vw; height: 100vh; }
        input[type="file"] { display: none; }
        body { margin: 0; overflow: hidden; background-color: #000; }
        #info { position: absolute; top: 25px; left: 25px; color: #FFD700; font-family: "Georgia", serif; font-size: 40px; pointer-events: none; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>
</head>
<body>
    <div id="info">
        <h2 style="margin:0;">MerryChristmas!</h2>
        <div style="font-size: 20px; opacity: 0.7; padding-left: 5px;">All I want for Christmas is you~</div>
    </div>

    <div id="start-overlay">
        <h1 style="letter-spacing: 10px; font-weight: 100; margin-bottom: 40px;">AURORA 3D</h1>
        <button class="btn-ui" style="padding: 15px 50px; font-size: 16px; border-radius: 30px;" onclick="initSystem()">å¼€å¯åˆ›æ„ç©ºé—´</button>
    </div>

    <div id="sidebar">
        <h3>èµ„æºç¼–è¾‘å™¨</h3>
        <div class="upload-section">
            <span class="section-title">èƒŒæ™¯éŸ³ä¹é€šé“</span>
            <label class="btn-ui">è®¾ç½® BGM <input type="file" id="bgm-upload" accept="audio/*"></label>
            <div id="cur-bgm" style="margin-top: 10px; font-size: 11px; color: #81c784;">æœªåŠ è½½èƒŒæ™¯éŸ³</div>
        </div>
        <div class="upload-section">
            <span class="section-title">ç…§ç‰‡é…å¯¹é€šé“</span>
            <label class="btn-ui">æ‰¹é‡ä¸Šä¼ å›¾ç‰‡ä¸éŸ³ä¹ <input type="file" id="assets-upload" multiple accept="image/*,audio/*"></label>
            <p style="font-size: 10px; color: #666; margin-top: 8px;">* ä¿æŒå›¾ç‰‡ä¸éŸ³ä¹æ–‡ä»¶åä¸€è‡´å³å¯è‡ªåŠ¨ç»‘å®š</p>
        </div>
        <span class="section-title">ç©ºé—´èµ„æºåˆ—è¡¨ (å¯è°ƒèŠ‚ç‹¬ç«‹éŸ³é‡)</span>
        <div id="res-list" class="resource-list"></div>
    </div>

    <div id="now-playing">
        <div style="opacity: 0.5; font-size: 11px; letter-spacing: 1px;">NOW PLAYING</div>
        <div id="track-info" style="font-size: 18px; font-weight: 300;">é™éŸ³ä¸­</div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        
        // --- å…³é”®å®šä¹‰ï¼šå¿…é¡»åŠ åœ¨ script é¡¶éƒ¨ ---
        let photoMeshes = [];      // å­˜æ”¾ç…§ç‰‡æ¨¡å‹
        let audioPool = new Map(); // å­˜æ”¾ åå­—->éŸ³ä¹URL çš„æ˜ å°„
        let activePhotoAudio = null; // å½“å‰æ­£åœ¨æ’­æ”¾çš„ç…§ç‰‡éŸ³ä¹
        let globalBGM = null;      // å…¨å±€èƒŒæ™¯éŸ³ä¹
        let focusedMesh = null; // è®°å½•å½“å‰é”å®šçš„ç…§ç‰‡
        let isLocked = false;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        window.initSystem = function() {
            const overlay = document.getElementById('start-overlay');
            gsap.to(overlay, { 
                opacity: 0, 
                duration: 1.5, 
                onComplete: () => {
                    overlay.style.display = 'none';
                    // 1. å°†æ¸²æŸ“å™¨æ”¾å…¥å®¹å™¨
                    document.getElementById('canvas-container').appendChild(renderer.domElement);
                        
                    // 2. ä¿®æ­£å°ºå¯¸
                    window.dispatchEvent(new Event('resize')); 

                    loadStaticAssets();
                        
                    // 3. æ ¸å¿ƒï¼šåœ¨è¿™é‡Œå¯åŠ¨æ¸²æŸ“å¾ªç¯
                    animate();
                } 
            });
        };

        function loadStaticAssets() {
            // 1. åŠ è½½èƒŒæ™¯éŸ³ä¹ (ç›¸å¯¹è·¯å¾„)
            globalBGM = new Audio('assets/bgm.mp3'); 
            globalBGM.loop = true;
            globalBGM.volume = 0.3;
            globalBGM.play().catch(e => console.log("ç­‰å¾…ç”¨æˆ·äº¤äº’åæ’­æ”¾"));
            document.getElementById('track-info').innerText = "èƒŒæ™¯éŸ³ä¹æ’­æ”¾ä¸­";

            // 2. åŠ è½½ç…§ç‰‡å’Œé…å¯¹éŸ³ä¹ (ç›¸å¯¹è·¯å¾„)
            // åœ¨è¿™é‡Œåˆ—å‡ºä½ æƒ³å±•ç¤ºçš„æ–‡ä»¶åï¼ˆä¸è¦åç¼€ï¼‰
            const myFiles = ["A Nonsense Christmas", "All I Want for Christmas Is You", "Jingle Bells", "Last Christmas", "Mistletoe", "Santa Tell Me", "Snowman", "We Wish You a Merry Christmas", "åœ£è¯ç»“", "åœ£è¯æ˜Ÿ", "ì²« ëˆˆ (åˆé›ª)"]; 
            
            myFiles.forEach(name => {
                // è®¾ç½®éŸ³ä¹æ˜ å°„ï¼šåå­— -> ç›¸å¯¹è·¯å¾„åœ°å€
                audioPool.set(name, `assets/${name}.mp3`);
                // åŠ è½½å›¾ç‰‡ï¼šåå­— -> ç›¸å¯¹è·¯å¾„åœ°å€
                create3DPhoto(name, `assets/${name}.jpg`);
            });
        }


        const CONFIG = {
            count: 2400, // ç¨å¾®å¢åŠ äº†æ€»æ•°ä»¥å®¹çº³æ–°å¢çš„å°é‡‘çƒ
            dustCount: 5000,
            treeHeight: 34,
            treeRadius: 14,
            lerpSpeed: 0.05
        };

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 55);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.6; 
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.6, 0.5, 0.85);
        composer.addPass(bloom);

        scene.add(new THREE.AmbientLight(0xffffff, 0.4)); 
        
        const lightSpecs = [
            { pos: [35, 25, 35], color: 0xffffff, intensity: 800 },
            { pos: [-35, 15, 35], color: 0xfff5d7, intensity: 800 },
            { pos: [0, 30, -40], color: 0xffffff, intensity: 600 },
            { pos: [0, -10, 45], color: 0xffe4b5, intensity: 1000 }
        ];

        lightSpecs.forEach(spec => {
            const pLight = new THREE.PointLight(spec.color, spec.intensity, 150);
            pLight.position.set(...spec.pos);
            scene.add(pLight);
        });

        const particles = [];
        const meshGroup = new THREE.Group();
        scene.add(meshGroup);

        // é¢„å®šä¹‰å“‘å…‰é‡‘æè´¨
        const matteGoldMat = new THREE.MeshStandardMaterial({ color: 0xD4AF37, roughness: 1.0, metalness: 0 });

        for (let i = 0; i < CONFIG.count; i++) {
            let mesh, type;
            const rand = Math.random();
            const t = i / CONFIG.count;

            if (rand < 0.25) { 
                type = 'GREEN';
                const w = 0.5 + Math.random() * 1.2;
                const h = 0.4 + Math.random() * 0.6;
                const d = 0.5 + Math.random() * 1.2;
                mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(w, h, d), 
                    new THREE.MeshStandardMaterial({ color: 0x008800, roughness: 0.9, metalness: 0 })
                );
            } else if (rand < 0.4) { 
                type = 'RED';
                const redMat = new THREE.MeshStandardMaterial({ color: 0x7B0000, roughness: 0.1, metalness: 0.3 });
                mesh = rand < 0.35 ? 
                    new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.7, 0.7), redMat) : 
                    new THREE.Mesh(new THREE.SphereGeometry(0.4, 12, 12), redMat);
            } else if (rand < 0.8) { 
                type = 'GOLD';
                // ä¿®æ”¹ï¼šæ ‘å¹²é‡‘å±çƒä¸€åŠæ¢æˆå“‘å…‰
                const isMatte = Math.random() > 0.8;
                mesh = new THREE.Mesh(
                    new THREE.SphereGeometry(0.45, 16, 16), 
                    isMatte ? matteGoldMat : new THREE.MeshStandardMaterial({ color: 0xFFD700, roughness: 0, metalness: 1.0 })
                );
            } else if (rand < 0.95) {
                // æ–°å¢ï¼šæ›´å°çš„ä¼šå‘å…‰çš„é‡‘çƒ
                type = 'TINY_GLOW_GOLD';
                mesh = new THREE.Mesh(
                    new THREE.SphereGeometry(0.05, 12, 12),
                    new THREE.MeshStandardMaterial({ 
                        color: 0xFFF5E1, 
                        emissive: 0xFFAA00, 
                        emissiveIntensity: 2.0,
                        metalness: 1.0,
                        roughness: 0
                    })
                );
            } else {
                type = 'WARM_GLOW';
                mesh = new THREE.Mesh(new THREE.SphereGeometry(0.7, 16, 16), new THREE.MeshStandardMaterial({ 
                    color: 0xFFF5E1, emissive: 0xFFAA00, emissiveIntensity: 2.0, metalness: 1, roughness: 0 
                }));
                const glowLight = new THREE.PointLight(0xFFAA00, 8, 5);
                mesh.add(glowLight);
            }

            // é¡¶éƒ¨çƒç‹¬ç«‹é€»è¾‘
            if (t > 0.995) {
                type = 'TOP_BALL';
                mesh = new THREE.Mesh(new THREE.OctahedronGeometry(1.5, 0), matteGoldMat);
            }

            const y = (t - 0.5) * CONFIG.treeHeight;
            const spiralAngle = t * 45 * Math.PI;
            const layerWave = Math.sin(t * 30) * 0.15 + 0.85; 
            const rBase = (1 - t) * CONFIG.treeRadius * layerWave;
            const yOffset = (Math.random() - 0.5) * 0.5;
            
            let offsetR;
            if (type === 'WARM_GLOW') {
                offsetR = rBase * Math.random() * 0.7; 
            } else if (type === 'GREEN') {
                offsetR = rBase * Math.random();
            } else if (type === 'TOP_BALL') {
                offsetR = rBase * (Math.random() * 0.3);
            } else if (type === 'TINY_GLOW_GOLD') {
                offsetR = rBase * (0.8 + Math.random() * 0.3); // è®©å‘å…‰å°é‡‘çƒç¨å¾€å¤–ä¾§é 
            } else {
                offsetR = rBase * (0.9 + Math.random() * 0.15);
            }

            const treePos = new THREE.Vector3(Math.cos(spiralAngle) * offsetR, y + yOffset, Math.sin(spiralAngle) * offsetR);
            const dist = 24 * Math.pow(Math.random(), 0.5);
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            const cloudPos = new THREE.Vector3(dist * Math.sin(phi) * Math.cos(theta), dist * Math.sin(phi) * Math.sin(theta), dist * Math.cos(phi));

            mesh.position.copy(treePos);
            meshGroup.add(mesh);
            particles.push({ mesh, treePos, cloudPos, vRot: new THREE.Vector3(Math.random()*0.02, Math.random()*0.03, 0.01) });
        }

        // æ˜Ÿå°˜é€»è¾‘
        const dustGeo = new THREE.BufferGeometry();
        const dustPos = new Float32Array(CONFIG.dustCount * 3);
        const dustTreeTargets = new Float32Array(CONFIG.dustCount * 3);
        const dustCloudTargets = new Float32Array(CONFIG.dustCount * 3);
        for (let i = 0; i < CONFIG.dustCount; i++) {
            const t = Math.random();
            const rTree = (1 - t) * CONFIG.treeRadius * (Math.sin(t * 30) * 0.15 + 0.85); 
            const ang = Math.random() * Math.PI * 2;
            dustTreeTargets[i*3] = Math.cos(ang) * rTree;
            dustTreeTargets[i*3+1] = (t - 0.5) * CONFIG.treeHeight;
            dustTreeTargets[i*3+2] = Math.sin(ang) * rTree;
            const rC = 25 + Math.random() * 20;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            dustCloudTargets[i*3] = rC * Math.sin(phi) * Math.cos(theta);
            dustCloudTargets[i*3+1] = rC * Math.sin(phi) * Math.sin(theta);
            dustCloudTargets[i*3+2] = rC * Math.cos(phi);
        }
        dustGeo.setAttribute('position', new THREE.BufferAttribute(dustPos, 3));
        const dustPoints = new THREE.Points(dustGeo, new THREE.PointsMaterial({ color: 0xFFD700, size: 0.12, transparent: true, opacity: 0.7 }));
        scene.add(dustPoints);

        let mode = 'TREE';

        window.addEventListener('mousedown', (e) => {
            if (e.target.closest('#sidebar')) return;

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            // é‡ç‚¹ 1ï¼šè¿™é‡Œåªæ£€æµ‹ç…§ç‰‡ photoMeshes
            const hits = raycaster.intersectObjects(photoMeshes);

            if (hits.length > 0) {
                // å¦‚æœç‚¹ä¸­äº†ç…§ç‰‡ï¼Œå°±æ”¾å¤§çœ‹ç…§ç‰‡
                focusOn(photoMeshes.indexOf(hits[0].object));
            } else {
                // é‡ç‚¹ 2ï¼šåªè¦æ²¡ç‚¹ä¸­ç…§ç‰‡ï¼ˆä¸ç®¡ä½ ç‚¹çš„æ˜¯æ ‘å¹²ã€è£…é¥°çƒè¿˜æ˜¯èƒŒæ™¯ï¼‰
                if (isLocked) {
                    exitFocus();
                } else {
                    // åˆ‡æ¢å½¢æ€
                    mode = (mode === 'TREE') ? 'CLOUD' : 'TREE';
                    console.log("å½¢æ€å·²åˆ‡æ¢:", mode);
                }
            }
        });


        function focusOn(index) {
            const mesh = photoMeshes[index];
            if (focusedMesh === mesh) return;

            focusedMesh = mesh;
            isLocked = true;

            // --- æ ¸å¿ƒï¼šè®¡ç®—ç›¸æœºå‰æ–¹çš„â€œç»å¯¹ä¸–ç•Œåæ ‡â€ ---
            const dist = 18; // è·ç¦»ç›¸æœºçš„è·ç¦»
            const worldPos = new THREE.Vector3(0, 0, -dist);
            worldPos.applyQuaternion(camera.quaternion);
            worldPos.add(camera.position);

            // --- å…³é”®ç‚¹ï¼šå°†ç…§ç‰‡æš‚æ—¶ç§»å‡ºæ—‹è½¬çš„ meshGroupï¼ŒæŒ‚è½½åˆ° scene ---
            // è¿™æ ·å®ƒå°±ä¸ä¼šå—æ ‘è‡ªè½¬çš„å½±å“äº†
            scene.attach(mesh); 

            // ä½¿ç”¨ GSAP å¹³æ»‘ç§»åŠ¨åˆ°ç›¸æœºå‰
            gsap.to(mesh.position, {
                x: worldPos.x,
                y: worldPos.y,
                z: worldPos.z,
                duration: 1.2,
                ease: "power2.out"
            });

            // è®©ç…§ç‰‡å¹³æ»‘è½¬è¿‡æ¥æ­£å¯¹ç€ç›¸æœº
            gsap.to(mesh.quaternion, {
                x: camera.quaternion.x,
                y: camera.quaternion.y,
                z: camera.quaternion.z,
                w: camera.quaternion.w,
                duration: 1.2
            });

            // è§†è§‰æ·¡åŒ–å…¶ä»–ç‰©ä½“
            photoMeshes.forEach(p => {
                const isCurrent = (p === mesh);
                gsap.to(p.material, { 
                    opacity: p === mesh ? 1 : 0.5, 
                    emissiveIntensity: p === mesh ? 0 : 0.3, 
                    duration: 0.8 
                });
            });
            
            // éšè—æ˜Ÿå°˜å’Œè£…é¥°çƒ
            gsap.to(dustPoints.material, { opacity: 0, duration: 0.8 });
            particles.forEach(p => {
                if (!p.mesh.userData.id) gsap.to(p.mesh.material, { opacity: 0.02, duration: 0.8 });
            });

            handleAudioSwitch(mesh.userData);
            document.getElementById('track-info').innerText = "æ­£åœ¨æµè§ˆ: " + mesh.userData.id;
        }

        function exitFocus() {
            if (!focusedMesh) return;

            // --- å…³é”®ç‚¹ï¼šå°†ç…§ç‰‡é‡æ–°æ”¾å›æ—‹è½¬ç»„ ---
            meshGroup.attach(focusedMesh);

            // è®©ç…§ç‰‡å¹³æ»‘å›åˆ°æ ‘ä¸Šçš„åŸå§‹ä½ç½®
            gsap.to(focusedMesh.position, {
                x: focusedMesh.userData.homePos.x,
                y: focusedMesh.userData.homePos.y,
                z: focusedMesh.userData.homePos.z,
                duration: 1.2,
                ease: "power2.inOut"
            });

            gsap.to(focusedMesh.quaternion, {
                x: focusedMesh.userData.homeRot.x,
                y: focusedMesh.userData.homeRot.y,
                z: focusedMesh.userData.homeRot.z,
                w: focusedMesh.userData.homeRot.w,
                duration: 1.2,
                onComplete: () => {
                    focusedMesh = null;
                    isLocked = false;
                }
            });

            // æ¢å¤è§†è§‰æ•ˆæœ
            photoMeshes.forEach(p => gsap.to(p.material, { opacity: 0.9, emissiveIntensity: 0.2, duration: 1 }));
            gsap.to(dustPoints.material, { opacity: 0.7, duration: 1 });
            particles.forEach(p => {
                if (!p.mesh.userData.id) gsap.to(p.mesh.material, { opacity: 1, duration: 1 });
            });

            if (activePhotoAudio) {
                gsap.to(activePhotoAudio, { volume: 0, duration: 0.6, onComplete: () => activePhotoAudio.pause() });
                restoreBGM();
            }
            document.getElementById('track-info').innerText = "å›åˆ°æ˜Ÿç©º";
        }
        
        function handleAudioSwitch(data) {
            if (globalBGM) gsap.to(globalBGM, { volume: 0, duration: 0.8 });
            if (activePhotoAudio) {
                const old = activePhotoAudio;
                gsap.to(old, { volume: 0, duration: 0.4, onComplete: () => old.pause() });
            }
            if (data && data.audioURL) {
                activePhotoAudio = new Audio(data.audioURL);
                activePhotoAudio.userDataId = data.id;
                activePhotoAudio.volume = 0;
                activePhotoAudio.play();
                gsap.to(activePhotoAudio, { volume: data.volume || 1, duration: 0.8 });
                activePhotoAudio.onended = () => restoreBGM();
            }
        }
        function restoreBGM() {
            if (globalBGM) gsap.to(globalBGM, { volume: 0.3, duration: 1.5 });
        }
        window.updateItemVolume = function(id, val) {
            const mesh = photoMeshes.find(m => m.userData.id === id);
            if (mesh) {
                mesh.userData.volume = parseFloat(val);
                const txt = document.getElementById(`vol-txt-${id}`);
                if(txt) txt.innerText = Math.round(val * 100) + "%";
                if (activePhotoAudio && activePhotoAudio.userDataId === id) {
                    activePhotoAudio.volume = parseFloat(val);
                }
            }
        };
        window.deleteItem = function(id) {
            const idx = photoMeshes.findIndex(m => m.userData.id === id);
            if (idx > -1) {
                meshGroup.remove(photoMeshes[idx]); // ä»åœ£è¯æ ‘æ—‹è½¬ç»„é‡Œç§»é™¤
                photoMeshes.splice(idx, 1);
                renderSidebarList();
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            particles.forEach(p => {
                // --- æ ¸å¿ƒæ”¹åŠ¨ï¼šåªæœ‰è¿™ä¸€è¡Œ ---
                if (p.mesh.userData.id && focusedMesh === p.mesh) return; 

                const target = mode === 'TREE' ? p.treePos : p.cloudPos;
                if(target) p.mesh.position.lerp(target, CONFIG.lerpSpeed);
                
                if (p.vRot && (p.vRot.x !== 0 || p.vRot.y !== 0)) {
                    p.mesh.rotation.x += p.vRot.x; 
                    p.mesh.rotation.y += p.vRot.y;
                }
            });

            // æ˜Ÿå°˜é€»è¾‘ä¿æŒä¸å˜
            const dAttr = dustGeo.attributes.position;
            for (let i = 0; i < CONFIG.dustCount; i++) {
                const tx = mode === 'TREE' ? dustTreeTargets[i*3] : dustCloudTargets[i*3];
                const ty = mode === 'TREE' ? dustTreeTargets[i*3+1] : dustCloudTargets[i*3+1];
                const tz = mode === 'TREE' ? dustTreeTargets[i*3+2] : dustCloudTargets[i*3+2];
                dAttr.array[i*3] += (tx - dAttr.array[i*3]) * 0.03;
                dAttr.array[i*3+1] += (ty + Math.sin(time + i*0.1)*0.03 - dAttr.array[i*3+1]) * 0.03;
                dAttr.array[i*3+2] += (tz - dAttr.array[i*3+2]) * 0.03;
            }
            dAttr.needsUpdate = true;

            meshGroup.rotation.y += 0.005;

            // --- æ³¨æ„ï¼šåˆ æ‰ä½ åŸæœ¬è¿™é‡Œå¯¹ photoMeshes çš„äºŒæ¬¡éå† ---

            composer.render();
        }

        function create3DPhoto(id, url) {
                    new THREE.TextureLoader().load(url, (tex) => {
                        const aspect = tex.image.width / tex.image.height;
                        URL.revokeObjectURL(url);
                        tex.colorSpace = THREE.SRGBColorSpace;
                        const mat = new THREE.MeshStandardMaterial({
                            map: tex, 
                            transparent: true, 
                            side: THREE.DoubleSide, 
                            emissive: new THREE.Color(0xd4af37),
                            emissiveIntensity: 0.2,
                            alphaTest: 0.5,
                        });
                        
                        const mesh = new THREE.Mesh(new THREE.PlaneGeometry(4 * aspect, 4), mat);

                        // --- ä»…åœ¨æ­¤å¤„å¢åŠ é˜²é‡å é€»è¾‘ ---
                        let y, spiralAngle, offsetR;
                        let foundSpace = false;
                        let attempts = 0;
                        const minDistance = 7; // ä½ å¯ä»¥è°ƒæ•´è¿™ä¸ªæ•°å€¼ï¼Œæ•°å€¼è¶Šå¤§ç…§ç‰‡ç¦»å¾—è¶Šå¼€

                        while (!foundSpace && attempts < 30) {
                            const t = 0.2 + Math.random() * 0.7; 
                            y = (t - 0.5) * CONFIG.treeHeight;
                            spiralAngle = t * 45 * Math.PI + (Math.random() * 5); // ç¨å¾®åŠ å¤§éšæœºæ—‹è½¬
                            const rBase = (1 - t) * CONFIG.treeRadius * (Math.sin(t * 30) * 0.15 + 0.85);
                            offsetR = rBase * 1.3;

                            const testPos = new THREE.Vector3(Math.cos(spiralAngle) * offsetR, y, Math.sin(spiralAngle) * offsetR);
                            
                            // æ£€æŸ¥æ–°ä½ç½®æ˜¯å¦ç¦»å·²æœ‰ç…§ç‰‡å¤ªè¿‘
                            const tooClose = photoMeshes.some(p => p.position.distanceTo(testPos) < minDistance);
                            
                            if (!tooClose || photoMeshes.length === 0) {
                                mesh.position.copy(testPos);
                                foundSpace = true;
                            }
                            attempts++;
                        }
                        // ------------------------------

                        mesh.lookAt(0, y, 0); 
                        mesh.rotation.y += Math.PI; 

                        mesh.userData.homePos = mesh.position.clone();
                        mesh.userData.homeRot = mesh.quaternion.clone();
                        mesh.userData.id = id;
                        mesh.userData.audioURL = audioPool.get(id);
                        
                        const cloudDist = 15 + Math.random() * 10;
                        const theta = Math.random() * Math.PI * 2;
                        const phi = Math.acos(2 * Math.random() - 1);
                        const cloudPos = new THREE.Vector3(
                            cloudDist * Math.sin(phi) * Math.cos(theta),
                            cloudDist * Math.sin(phi) * Math.sin(theta) + 5,
                            cloudDist * Math.cos(phi)
                        );

                        particles.push({ 
                            mesh: mesh, 
                            treePos: mesh.position.clone(), 
                            cloudPos: cloudPos,
                            vRot: new THREE.Vector3(0, 0, 0) 
                        });
                        meshGroup.add(mesh);
                        photoMeshes.push(mesh);
                        renderSidebarList();
                    });
                }

        function renderSidebarList() {
            const container = document.getElementById('res-list');
            container.innerHTML = '';
            photoMeshes.forEach(mesh => {
                const id = mesh.userData.id;
                const hasAudio = !!mesh.userData.audioURL;
                const item = document.createElement('div');
                item.className = 'resource-item';
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:180px;">
                            ${id} ${hasAudio ? 'ğŸµ' : 'ğŸ–¼ï¸'}
                        </span>
                        <span class="delete-btn" onclick="deleteItem('${id}')">Ã—</span>
                    </div>
                    <div class="vol-controls">
                        <span class="vol-label">éŸ³é‡</span>
                        <input type="range" class="vol-slider" min="0" max="1" step="0.01" value="1" 
                            oninput="updateItemVolume('${id}', this.value)">
                        <span class="vol-label" id="vol-txt-${id}">100%</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // èƒŒæ™¯éŸ³ä¹ä¸Šä¼ 
        document.getElementById('bgm-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (globalBGM) globalBGM.pause();
            globalBGM = new Audio(URL.createObjectURL(file));
            globalBGM.loop = true;
            globalBGM.volume = 0.3;
            globalBGM.play();
            document.getElementById('cur-bgm').innerText = "å·²åŠ è½½: " + file.name;
            document.getElementById('track-info').innerText = "èƒŒæ™¯éŸ³ä¹: " + file.name;
        });

        // æ‰¹é‡å›¾ç‰‡ä¸éŸ³ä¹é…å¯¹ä¸Šä¼ 
        document.getElementById('assets-upload').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            
            // 1. å…ˆå­˜éŸ³ä¹
            files.filter(f => f.type.startsWith('audio/')).forEach(file => {
                const name = file.name.split('.')[0];
                audioPool.set(name, URL.createObjectURL(file));
            });

            // 2. å†å¤„ç†å›¾ç‰‡
            files.filter(f => f.type.startsWith('image/')).forEach(file => {
                const name = file.name.split('.')[0];
                const url = URL.createObjectURL(file);
                create3DPhoto(name, url); 
            });
        });
    </script>
</body>
</html>


